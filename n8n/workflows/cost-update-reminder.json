{
  "name": "Cost Update Reminder",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "cronExpression": "0 9 1 * *"
        }
      },
      "id": "monthly-trigger",
      "name": "Monthly on 1st at 9 AM",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{$env.API_URL}}/api/cost-calculations/outdated",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.API_TOKEN}}"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-outdated-costs",
      "name": "Fetch Outdated Costs",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [450, 300]
    },
    {
      "parameters": {
        "functionCode": "// Group costs by type\nconst costs = items[0].json.data || [];\n\nconst materialCosts = costs.filter(c => c.cost_type === 'material');\nconst processCosts = costs.filter(c => c.cost_type === 'process');\nconst overheadCosts = costs.filter(c => c.cost_type === 'overhead');\n\nreturn [{\n  json: {\n    total_outdated: costs.length,\n    material_costs: materialCosts,\n    process_costs: processCosts,\n    overhead_costs: overheadCosts,\n    has_outdated: costs.length > 0\n  }\n}];"
      },
      "id": "group-costs",
      "name": "Group Costs by Type",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.has_outdated}}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-has-outdated",
      "name": "IF Has Outdated Costs",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "functionCode": "// Create notification messages for each department\nconst data = items[0].json;\nconst notifications = [];\n\nif (data.material_costs.length > 0) {\n  notifications.push({\n    json: {\n      department: 'materials',\n      email: 'materials@fastenmind.com',\n      costs: data.material_costs,\n      count: data.material_costs.length,\n      subject: `${data.material_costs.length} å€‹ææ–™æˆæœ¬éœ€è¦æ›´æ–°`\n    }\n  });\n}\n\nif (data.process_costs.length > 0) {\n  notifications.push({\n    json: {\n      department: 'engineering',\n      email: 'engineering@fastenmind.com',\n      costs: data.process_costs,\n      count: data.process_costs.length,\n      subject: `${data.process_costs.length} å€‹è£½ç¨‹æˆæœ¬éœ€è¦æ›´æ–°`\n    }\n  });\n}\n\nif (data.overhead_costs.length > 0) {\n  notifications.push({\n    json: {\n      department: 'finance',\n      email: 'finance@fastenmind.com',\n      costs: data.overhead_costs,\n      count: data.overhead_costs.length,\n      subject: `${data.overhead_costs.length} å€‹ç®¡ç†æˆæœ¬éœ€è¦æ›´æ–°`\n    }\n  });\n}\n\nreturn notifications;"
      },
      "id": "prepare-notifications",
      "name": "Prepare Department Notifications",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "fromEmail": "system@fastenmind.com",
        "toEmail": "={{$json.email}}",
        "subject": "ğŸ“Š æˆæœ¬æ›´æ–°æé†’: {{$json.subject}}",
        "text": "æ‚¨å¥½ï¼Œ\n\nç³»çµ±åµæ¸¬åˆ°ä»¥ä¸‹æˆæœ¬è³‡æ–™å·²è¶…é30å¤©æœªæ›´æ–°ï¼Œè«‹ç›¡å¿«æª¢è¦–ä¸¦æ›´æ–°ï¼š\n\n{{$json.costs.map(c => `- ${c.name}: æœ€å¾Œæ›´æ–° ${c.last_updated}`).join('\\n')}}\n\nè«‹ç™»å…¥ç³»çµ±é€²è¡Œæ›´æ–°ï¼š{{$env.APP_URL}}/cost-management\n\næ­¤ç‚ºç³»çµ±è‡ªå‹•é€šçŸ¥ï¼Œè«‹å‹¿å›è¦†ã€‚",
        "html": "<h2>æˆæœ¬æ›´æ–°æé†’</h2><p>æ‚¨å¥½ï¼Œ</p><p>ç³»çµ±åµæ¸¬åˆ°ä»¥ä¸‹æˆæœ¬è³‡æ–™å·²è¶…é30å¤©æœªæ›´æ–°ï¼Œè«‹ç›¡å¿«æª¢è¦–ä¸¦æ›´æ–°ï¼š</p><ul>{{$json.costs.map(c => `<li><strong>${c.name}</strong>: æœ€å¾Œæ›´æ–° ${c.last_updated}</li>`).join('')}}</ul><p><a href='{{$env.APP_URL}}/cost-management' style='background: #2563eb; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin-top: 15px;'>ç«‹å³æ›´æ–°</a></p><hr><p style='color: #666; font-size: 12px;'>æ­¤ç‚ºç³»çµ±è‡ªå‹•é€šçŸ¥ï¼Œè«‹å‹¿å›è¦†ã€‚</p>",
        "options": {}
      },
      "id": "send-email",
      "name": "Send Email Notification",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [1250, 300],
      "credentials": {
        "smtp": {
          "id": "1",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.API_URL}}/api/notifications/bulk",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "notifications",
              "value": "={{$json.costs.map(c => ({ user_id: c.responsible_user_id, type: 'cost_update_required', title: `æˆæœ¬æ›´æ–°æé†’: ${c.name}`, message: `${c.name} å·²è¶…é30å¤©æœªæ›´æ–°`, entity_type: 'cost', entity_id: c.id }))}}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.API_TOKEN}}"
            }
          ]
        },
        "options": {}
      },
      "id": "create-notifications",
      "name": "Create In-App Notifications",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1250, 450]
    },
    {
      "parameters": {
        "channel": "#operations",
        "text": ":warning: æˆæœ¬æ›´æ–°æé†’\n\næœ¬æœˆå…±æœ‰ {{$json.total_outdated}} å€‹æˆæœ¬é …ç›®éœ€è¦æ›´æ–°ï¼š\n\nâ€¢ ææ–™æˆæœ¬: {{$json.material_costs.length}} é …\nâ€¢ è£½ç¨‹æˆæœ¬: {{$json.process_costs.length}} é …\nâ€¢ ç®¡ç†æˆæœ¬: {{$json.overhead_costs.length}} é …\n\nç›¸é—œéƒ¨é–€ä¸»ç®¡å·²æ”¶åˆ°éƒµä»¶é€šçŸ¥ã€‚",
        "options": {
          "attachments": {
            "values": [
              {
                "color": "#ff6b6b",
                "title": "éœ€è¦ç«‹å³è™•ç†",
                "title_link": "{{$env.APP_URL}}/cost-management",
                "text": "è«‹å„éƒ¨é–€ä¸»ç®¡ç£ä¿ƒåœ˜éšŠåœ¨æœ¬é€±å…§å®Œæˆæ›´æ–°"
              }
            ]
          }
        }
      },
      "id": "slack-summary",
      "name": "Slack Summary",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2,
      "position": [1050, 500],
      "credentials": {
        "slackApi": {
          "id": "2",
          "name": "Slack account"
        }
      }
    }
  ],
  "connections": {
    "monthly-trigger": {
      "main": [
        [
          {
            "node": "fetch-outdated-costs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fetch-outdated-costs": {
      "main": [
        [
          {
            "node": "group-costs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "group-costs": {
      "main": [
        [
          {
            "node": "if-has-outdated",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if-has-outdated": {
      "main": [
        [
          {
            "node": "prepare-notifications",
            "type": "main",
            "index": 0
          },
          {
            "node": "slack-summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare-notifications": {
      "main": [
        [
          {
            "node": "send-email",
            "type": "main",
            "index": 0
          },
          {
            "node": "create-notifications",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {},
  "versionId": "1",
  "id": "cost_update_reminder",
  "meta": {
    "instanceId": "fastenmind"
  },
  "tags": ["cost", "scheduled", "reminder"]
}